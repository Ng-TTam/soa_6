<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>IOT-N13</title>
<!-- Tell the browser to be responsive to screen width -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Font Awesome -->
<link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
<!-- Ionicons -->
<link rel="stylesheet"
	href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
<!-- Tempusdominus Bbootstrap 4 -->
<link rel="stylesheet"
	href="plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
<!-- iCheck -->
<link rel="stylesheet"
	href="plugins/icheck-bootstrap/icheck-bootstrap.min.css">
<!-- JQVMap -->
<link rel="stylesheet" href="plugins/jqvmap/jqvmap.min.css">
<!-- Theme style -->
<link rel="stylesheet" href="dist/css/adminlte.min.css">
<!-- overlayScrollbars -->
<link rel="stylesheet"
	href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
<!-- Daterange picker -->
<link rel="stylesheet"
	href="plugins/daterangepicker/daterangepicker.css">
<!-- summernote -->
<link rel="stylesheet" href="plugins/summernote/summernote-bs4.css">
<!-- Google Font: Source Sans Pro -->
<link
	href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700"
	rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
.table-dark tr th {
	text-align: center;
}

.table tbody tr th {
	text-align: center;
	vertical-align: middle;
}

/* CSS cho các trang khác */
#chartSelect {
	padding: 5px; /* Kích thước padding bên trong select */
	border: 1px solid red; /* Viền xung quanh select */
	border-radius: 4px; /* Bo tròn viền của select */
	font-size: 15px; /* Kích thước chữ */
	background-color: #fff; /* Màu nền của select */
	color: #333; /* Màu chữ của select */
	appearance: none;
	/* Ẩn giao diện mặc định của select (đối với trình duyệt webkit-based) */
	cursor: pointer; /* Con trỏ khi hover qua select */
}

/* Tùy chỉnh giao diện cho tùy chọn option */
#chartSelect option {
	font-size: 14px; /* Kích thước chữ */
	background-color: #fff; /* Màu nền của option */
	color: #333; /* Màu chữ của option */
}

/* Tùy chỉnh giao diện khi select được nhấp chọn */
#chartSelect:focus {
	border-color: #007bff; /* Màu viền khi select được chọn */
	box-shadow: 0 0 5px rgb(64, 128, 128);
	/* Hiệu ứng bóng khi select được chọn */
}

/* Tùy chỉnh giao diện khi hover qua option */
#chartSelect option:hover {
	background-color: #007bff; /* Màu nền khi hover qua option */
	color: #fff; /* Màu chữ khi hover qua option */
}

#page-numbers1 button {
	margin-right: 1px;
	margin-left: 1px;
	width: 30px;
}

#pagination1 {
	display: flex;
	justify-content: center;
	align-items: center;
	margin-top: 10px;
	/* Điều chỉnh khoảng cách giữa container và pagination theo ý muốn */
}

#pagination1 #page-numbers1 :active {
	background-color: gray;
}

#page-numbers1 button.active {
	border-color: gray !important;
	background-color: gray !important;
	color: white !important;
}

#page-numbers1 {
	display: flex;
	justify-content: center;
	align-items: center;
}

#page-numbers1 button {
	margin-right: 1px;
	margin-left: 1px;
	width: 30px;
	border: 1px solid black; /* Viền màu đen */
}

#page-numbers1 button.active {
	border-color: gray; /* Viền màu đỏ cho nút đã chọn */
	background-color: gray; /* Nền màu đỏ cho nút đã chọn */
	color: white; /* Màu chữ trắng cho nút đã chọn */
}

#page-numbers2 button {
	margin-right: 1px;
	margin-left: 1px;
	width: 30px;
}

#pagination2 {
	display: flex;
	justify-content: center;
	align-items: center;
	margin-top: 10px;
	/* Điều chỉnh khoảng cách giữa container và pagination theo ý muốn */
}

#pagination2 #page-numbers2 :active {
	background-color: gray;
}

#page-numbers2 button.active {
	border-color: gray !important;
	background-color: gray !important;
	color: white !important;
}

#page-numbers2 {
	display: flex;
	justify-content: center;
	align-items: center;
}

#page-numbers2 button {
	margin-right: 1px;
	margin-left: 1px;
	width: 30px;
	border: 1px solid black; /* Viền màu đen */
}

#page-numbers2 button.active {
	border-color: gray; /* Viền màu đỏ cho nút đã chọn */
	background-color: gray; /* Nền màu đỏ cho nút đã chọn */
	color: white; /* Màu chữ trắng cho nút đã chọn */
}

.custom-modal {
	display: none;
	position: fixed;
	z-index: 1;
	background-color: #fefefe;
	border: 1px solid #888;
	max-width: 100%;
	max-height: 100%;
	width: auto;
	height: auto;
	text-align: center;
	overflow: hidden;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
}

.modal-content {
	display: flex;
	align-items: center;
	justify-content: center;
	width: 100%;
	height: 100%;
	max-width: none;
	max-height: none;
}

.modal-content img {
	max-width: 100%;
	max-height: 100%;
	width: auto;
	height: auto;
}

.enlarged-modal img {
	max-width: 350px;
	max-height: 370px;
	width: auto;
	height: auto;
}

#enlargeButton {
	position: absolute;
	top: 3px;
	left: 0;
	right: 0;
	font-size: 20px;
	cursor: pointer;
	display: flex;
	justify-content: center;
	z-index: 1; /* Để nút nằm phía trên hình ảnh */
}

#imageContainer {
	display: none;
	position: relative;
}

#closeButton {
	position: absolute;
	top: 5px;
	right: 5px;
	cursor: pointer;
}
</style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
	<div class="wrapper">

		<!-- Navbar -->
		<nav class="main-header navbar navbar-expand navbar-white navbar-light" style="height: 45px">
		    <!-- Left navbar links -->
		    <ul class="navbar-nav">
				<li class="nav-item"><a class="nav-link" data-widget="pushmenu"
					href="#" role="button"><i class="fas fa-bars"></i></a></li>
			</ul>
		    <div class="navbar-brand mx-auto">
		        <h3 style="margin: 0;">Cấu hình</h3>
		    </div>
		</nav>

		<!-- /.navbar -->

		<!-- Main Sidebar Container -->
		<aside class="main-sidebar sidebar-dark-primary elevation-4">
			<!-- Brand Logo -->
			<!-- Sidebar -->
			<div style="height: 430px" class="sidebar">
				<!-- Sidebar user panel (optional) -->
				<div class="user-panel mt-3 pb-3 mb-3 d-flex">
					<div class="image">
						<i style="margin-left: 9px;margin-top: 10px;color: white;" class="fa fa-user-circle nav-icon"></i>
					</div>
					<div class="info">
						<a href="#" class="d-block" style="text-decoration: none" th:if = "${session.account!=null}">[[${session.account.username}]]</a>
					</div>
				</div>

				<!-- Sidebar Menu -->
				<nav class="mt-2">
					<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
          <li class="nav-item has-treeview menu-open">
            <a style="background-color: rgb(32,178,170)" th:href="@{/report}" class="nav-link active">
              <i class="nav-icon fa fa-area-chart"></i>
              <p>
                Báo cáo, Thống kê
              </p>
            </a>
          </li>      
          <li class="nav-item has-treeview menu-open">
            <a href="#" class="nav-link">
              <i class="nav-icon fa fa-institution"></i>
              <p>
                Quản Lý
                <i class="fas fa-angle-left right"></i>
                <span class="badge badge-info right">1</span>
              </p>
            </a>
            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a th:href="@{/list/person}" class="nav-link">
                  <i class="fa fa-pencil-square-o nav-icon"></i>
                  <p>Danh sách nộp thuế</p>
                </a>
              </li>
              <li class="nav-item">
                 <a th:href="@{/setting}" class="nav-link active"> <i class="fa fa-gear nav-icon"></i>
				  <p style="margin-right:50px">Cấu hình</p>
			     </a>
			 </li>     
            </ul>
          </li>
          <li class="nav-item">
                <a th:href="@{/logout}" class="nav-link">
                  <i class="fa fa-sign-out nav-icon"></i>
                  <p>Thoát</p>
                </a>
              </li> 
        </ul>
					
				</nav>
				<!-- /.sidebar-menu -->
			</div>
			<!-- /.sidebar -->
		</aside>

		 <div style="background-color: white; margin-top:50px" class="content-wrapper">
		    <div style="width: 700px;background-color: white;" class="container">
		        <div style="height: 300px; display: flex; flex-direction: column;">
		            <div style="flex: 1;">
		                <table class="table table-striped table-bordered" style="margin: 0 auto;">
		                    <thead class="table-dark">
		                        <tr>
		                            <th>Bậc thuế</th>
		                            <th>Phần thu nhập nhỏ nhất</th>
		                            <th>Phần thu nhập lớn nhất</th>
		                            <th>Thuế suất</th>
		                        </tr>
		                    </thead>
		                    <tbody id="taxTableBody" style="text-align: center;">
		                    </tbody>
		                </table>
		            </div>
		            <!-- Nút "Edit" được đặt bên phải và nằm dưới bảng -->
		            <div style="text-align: right;">
		                <button onclick="toggleEditMode()" class="btn btn-primary" style="margin-top: 20px;">Save</button>
		            </div>
		        </div>
		    </div>
		</div>


		
		<aside class="control-sidebar control-sidebar-dark">
			<!-- Control sidebar content goes here -->
		</aside>
		<!-- /.control-sidebar -->
	</div>
	

</body>
<script>
function toggleEditMode() {
    const tableBody = document.getElementById('taxTableBody');
    const editButton = document.querySelector('button');
    const taxList = [];

    // Lặp qua từng hàng trong bảng để thu thập thông tin và tạo các đối tượng tax
    tableBody.querySelectorAll('tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        const tax = {
            id: cells[0].textContent,
            taxBacket: cells[0].textContent,
            amountLeast: cells[1].textContent,
            amountLargest: cells[2].querySelector('input') ? cells[2].querySelector('input').value : '-1',
            percentOfTax: cells[3].querySelector('input').value
        };
        console.log(tax);
        taxList.push(tax); // Thêm tax vào danh sách taxList
    });

    if (checkValuesValidity(taxList)) {
        // Gửi danh sách taxList đến API
        fetch('http://localhost:6677/api/taxes/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(taxList), // Chuyển danh sách thành dạng JSON
        })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                // Xử lý phản hồi từ API nếu cần
            })
            .catch((error) => {
                console.error('Error:', error);
            });

        window.alert("Dữ liệu đã được lưu thành công!");
        window.location.replace("http://localhost:6677/setting");
    } else {
        console.error("Invalid data. Please check again.");
    }
}

function checkValuesValidity(taxList) {
    for (let i = 0; i < taxList.length; i++) {
        if (/[a-zA-Z]/.test(taxList[i].amountLargest)) {
            alert("Phần thu nhập lớn nhất hàng " + (i + 1) + " chứa chữ! Vui lòng nhập số.");
            return false;
        }
        if (/[a-zA-Z]/.test(taxList[i].percentOfTax)) {
            alert("Phần thuế suất hàng " + (i + 1) + " chứa chữ! Vui lòng nhập số.");
            return false;
        }

        const currentAmount = parseFloat(taxList[i].amountLargest);
        const currentPercent = parseFloat(taxList[i].percentOfTax);

        if (isNaN(currentAmount) || isNaN(currentPercent)) {
            alert("Invalid data at row " + (i + 1) + ". Please enter valid numbers.");
            return false;
        }

        if (currentAmount < 0 && i != 6) {
            alert("Phần thu nhập lớn nhất hàng " + (i + 1) + " không thể là số âm.");
            return false;
        }

        if (currentPercent < 0) {
            alert("Phần thuế suất hàng " + (i + 1) + " không thể là số âm.");
            return false;
        }

        if (currentPercent == 0 || currentAmount == 0) {
            alert("Phần thuế suất và thu nhập lớn nhất của hàng " + (i + 1) + " phải khác 0.");
            return false;
        }

        // Kiểm tra xem nếu không phải là hàng cuối cùng
        if (i < taxList.length - 2) {
            const nextAmount = parseFloat(taxList[i + 1].amountLargest);
            const nextPercent = parseFloat(taxList[i + 1].percentOfTax);

            // Kiểm tra xem phần thu nhập lớn nhất hiện tại có nhỏ hơn phần thu nhập lớn nhất của hàng sau không
            if (currentAmount >= nextAmount) {
                alert("Phần thu nhập lớn nhất hàng " + (i + 1) + " không thể lớn hơn hoặc bằng phần thu nhập lớn nhất của hàng sau.");
                return false;
            }

            // Kiểm tra xem phần thuế suất hiện tại có nhỏ hơn phần thuế suất của hàng sau không
            if (currentPercent >= nextPercent) {
                alert("Phần thuế suất hàng " + (i + 1) + " không thể lớn hơn hoặc bằng phần thuế suất của hàng sau.");
                return false;
            }
        }

        if (i == taxList.length - 2) {
            const nextPercent = parseFloat(taxList[i + 1].percentOfTax);

            if (currentPercent >= nextPercent) {
                alert("Phần thuế suất hàng " + (i + 1) + " không thể lớn hơn hoặc bằng phần thuế suất của hàng sau.");
                return false;
            }

            if (nextPercent >= 100) {
                alert("Phần thuế suất hàng " + (i + 2) + " phải nhỏ hơn 100.");
                return false;
            }
        }
    }

    return true;
}

// Hàm cập nhật giá trị ở cột "Amount Least" của hàng tiếp theo
function updateAmountLeast(input) {
    const currentRow = input.parentNode.parentNode; // Ô nhập dữ liệu hiện tại
    const nextRow = currentRow.nextElementSibling; // Hàng tiếp theo
    if (nextRow) { // Kiểm tra xem có hàng tiếp theo không
        const amountLeastCell = nextRow.querySelector('td:nth-child(2)'); // Ô "Amount Least" của hàng tiếp theo
        if (amountLeastCell) { // Kiểm tra xem ô "Amount Least" có tồn tại không
            amountLeastCell.textContent = input.value; // Cập nhật
        }
    }
    }

    fetch('http://localhost:6677/api/taxes')
    .then(response => response.json()) // Chuyển đổi phản hồi sang JSON
    .then(data => {
    data.forEach(tax => {
    const amountLargest = tax.amountLargest === -1 ? "Không giới hạn" : tax.amountLargest; // Format số với dấu phẩy
    
    const row = `<tr>
        <td>${tax.taxBacket}</td>
        <td>${tax.amountLeast}</td>
        <td>${tax.amountLargest !== -1 ? `<input type="text" value="${amountLargest}" oninput="updateAmountLeast(this)">` : 'Không giới hạn'}</td>
        <td><input type="text" value="${tax.percentOfTax}" oninput="updatePercentOfTax(this)"></td>
      </tr>`;
    document.getElementById('taxTableBody').insertAdjacentHTML('beforeend', row);
    });
    })
    .catch(error => {
    console.error('Lỗi khi lấy dữ liệu từ API:', error);
    });

</script>

<script src="../../plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="../../dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="../../dist/js/demo.js"></script>


